# 畅理题库 - 环境变量配置指南

本文档将帮助你完成所有必要的环境配置，使项目能够正常运行。

---

## 📋 必需的外部服务

在配置环境变量之前，你需要准备以下服务：

### 1. Supabase 项目（数据库）
- 访问 [https://supabase.com](https://supabase.com)
- 创建新项目（免费套餐即可）
- 记录以下信息：
  - Project URL
  - service_role (secret) API Key

### 2. Redis 服务（队列系统）
**选项A：本地安装（开发环境推荐）**
```bash
# macOS
brew install redis
brew services start redis

# 验证
redis-cli ping  # 应返回 PONG
```

**选项B：使用 Redis Cloud（免费）**
- 访问 [https://redis.com/try-free/](https://redis.com/try-free/)
- 创建免费数据库（30MB）
- 记录连接字符串

**选项C：使用 Upstash（免费，推荐用于生产）**
- 访问 [https://upstash.com](https://upstash.com)
- 创建免费 Redis 数据库
- 记录 REST API URL 或 Redis URL

### 3. Gemini API（AI 功能，可选）
- 访问 [https://aistudio.google.com/app/apikey](https://aistudio.google.com/app/apikey)
- 创建 API Key（免费配额：每天15次/秒，1500次/天）
- 复制 API Key

---

## 🔧 环境变量配置

### 步骤 1：创建 `.env.local` 文件

在项目根目录创建 `.env.local` 文件：

```bash
cp .env.example .env.local
```

### 步骤 2：填写环境变量

打开 `.env.local`，填写以下内容：

```bash
# ================================
# Supabase 配置（必需）
# ================================
SUPABASE_URL=https://你的项目ID.supabase.co
SUPABASE_SERVICE_ROLE_KEY=你的service_role密钥

# ================================
# JWT 密钥（必需）
# ================================
# 用于生成用户登录 Token，建议使用随机字符串
JWT_SECRET=changli-dev-secret-请修改为随机字符串

# ================================
# Redis 配置（必需）
# ================================
# 选项1：本地 Redis
REDIS_URL=redis://localhost:6379

# 选项2：Redis Cloud / Upstash
# REDIS_URL=rediss://xxx:xxx@xxx.upstash.io:6379

# ================================
# Gemini API（可选但推荐）
# ================================
# 获取地址：https://aistudio.google.com/app/apikey
# 不填写会使用 Mock 模式，功能受限
GEMINI_API_KEY=你的Gemini_API_Key

# ================================
# 管理员邮箱（可选）
# ================================
# 配置后只有该邮箱可以访问管理面板
# 多个邮箱用英文逗号分隔
ADMIN_EMAILS=admin@example.com,manager@example.com

# ================================
# 可选配置
# ================================
# AI 每日使用限制（默认20次/天）
AI_DAILY_LIMIT=20

# 文件上传大小限制（默认10MB）
MAX_FILE_SIZE=10485760
```

### 步骤 3：详细配置说明

#### 3.1 Supabase 配置

1. 登录 Supabase 控制台
2. 进入你的项目
3. 点击 **Settings** → **API**
4. 复制以下信息：
   - **Project URL**: `https://xxxxx.supabase.co`
   - **service_role** (secret): `eyJhbGci...`

**⚠️ 重要**：使用 `service_role` key，而非 `anon` key，因为需要绕过 RLS 限制。

#### 3.2 Redis 配置

**本地开发环境：**
```bash
# 确保 Redis 正在运行
redis-server

# 测试连接
redis-cli ping
```

**生产环境（使用 Upstash）：**
```bash
# Redis URL 格式：
rediss://username:password@host:port
```

#### 3.3 Gemini API 配置

1. 访问 [Google AI Studio](https://aistudio.google.com/app/apikey)
2. 点击 "Create API Key"
3. 复制 API Key 到 `.env.local`

**免费配额限制**：
- 每分钟 15 次
- 每天 1500 次
- 对于 MVP 阶段足够使用

#### 3.4 管理员邮箱配置

如果不配置 `ADMIN_EMAILS`，所有已登录用户都可以访问管理面板。

配置后，只有列表中的邮箱可以访问 `/admin` 路径。

---

## 🗄️ 数据库初始化

### 步骤 1：运行 SQL Schema

1. 登录 Supabase 控制台
2. 点击 **SQL Editor**
3. 创建新查询
4. 复制 [`database/schema.sql`](database/schema.sql) 的内容
5. 点击运行

或者使用 Supabase CLI：
```bash
# 安装 Supabase CLI（如果还没安装）
brew install supabase/tap/supabase

# 链接到你的项目
supabase link --project-ref 你的项目ID

# 推送 schema
supabase db push
```

### 步骤 2：验证表创建

在 Supabase 控制台的 **Table Editor** 中，应该能看到以下表：
- ✅ users
- ✅ quizzes
- ✅ user_progress
- ✅ wrong_questions
- ✅ ai_conversations
- ✅ ai_usage
- ✅ error_reports
- ✅ jobs
- ✅ parse_logs

---

## 🚀 启动项目

### 1. 安装依赖

```bash
npm install
```

### 2. 启动开发服务器

```bash
# 终端1：启动 Next.js
npm run dev
```

项目将在 `http://localhost:3000` 启动。

### 3. 启动 Worker（用于题库解析）

**新开一个终端窗口**：
```bash
npm run worker
```

Worker 会监听队列，处理题库解析任务。

---

## ✅ 验证配置

### 检查清单

- [ ] Supabase 项目已创建，表已初始化
- [ ] `.env.local` 文件已创建并填写完整
- [ ] Redis 正在运行（`redis-cli ping` 返回 PONG）
- [ ] Next.js 开发服务器已启动（http://localhost:3000）
- [ ] Worker 已启动
- [ ] Gemini API Key 已配置（可选）

### 测试步骤

#### 1. 测试数据库连接
访问：`http://localhost:3000/register`
- 注册一个新用户
- 检查 Supabase 的 `users` 表，应该看到新记录

#### 2. 测试管理面板
- 使用注册的账号登录
- 如果配置了 `ADMIN_EMAILS`，确保使用配置的邮箱
- 访问：`http://localhost:3000/admin`
- 应该能看到管理面板

#### 3. 测试题库上传
- 在管理面板点击"上传题库"
- 上传一个测试文件（.txt 或 .md）
- 查看 Worker 终端，应该看到解析日志
- 刷新管理面板，题库状态应该更新

#### 4. 测试 AI 功能
- 在刷题页面点击"AI追问"
- 如果配置了 Gemini API Key，应该收到真实回复
- 否则会收到 Mock 提示

---

## 🐛 常见问题排查

### 问题 1：Supabase 连接失败
**错误信息**：`Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY`

**解决方法**：
1. 检查 `.env.local` 文件是否存在
2. 确认变量值正确（没有多余的空格或引号）
3. 重启开发服务器（`Ctrl+C` 然后 `npm run dev`）

### 问题 2：Redis 连接失败
**错误信息**：`Error: connect ECONNREFUSED 127.0.0.1:6379`

**解决方法**：
```bash
# 启动 Redis
brew services start redis

# 或者
redis-server
```

### 问题 3：Worker 无法启动
**错误信息**：`Cannot find module 'ts-node'`

**解决方法**：
```bash
npm install --save-dev ts-node
```

### 问题 4：题库解析失败
**可能原因**：
- Worker 未启动
- Redis 未连接
- 文件格式不正确

**解决方法**：
1. 确认 Worker 正在运行
2. 检查 Worker 终端的错误日志
3. 使用标准格式的测试文件

### 问题 5：AI 调用失败
**错误信息**：`Gemini 调用失败`

**解决方法**：
1. 确认 API Key 正确
2. 检查是否超过配额限制
3. 临时移除 API Key，使用 Mock 模式测试

---

## 📝 环境变量快速参考

| 变量名 | 必需 | 默认值 | 说明 |
|--------|------|--------|------|
| `SUPABASE_URL` | ✅ | - | Supabase 项目 URL |
| `SUPABASE_SERVICE_ROLE_KEY` | ✅ | - | Supabase service_role key |
| `JWT_SECRET` | ✅ | - | JWT 签名密钥 |
| `REDIS_URL` | ✅ | - | Redis 连接字符串 |
| `GEMINI_API_KEY` | ⚠️ | - | Gemini API Key（可选） |
| `ADMIN_EMAILS` | - | - | 管理员邮箱列表 |
| `AI_DAILY_LIMIT` | - | 20 | AI 每日使用限制 |
| `MAX_FILE_SIZE` | - | 10485760 | 最大文件大小（字节） |

---

## 🔐 生产环境部署建议

### 1. 环境变量管理
- 使用托管服务的环境变量配置（如 Vercel Environment Variables）
- 不要将 `.env.local` 提交到 Git
- 定期轮换敏感密钥

### 2. Redis 服务
- 生产环境推荐使用：
  - Upstash（免费额度足够）
  - Redis Cloud
  - AWS ElastiCache

### 3. 数据库备份
- 在 Supabase 控制台启用自动备份
- 定期导出数据库

### 4. 监控
- 配置错误追踪（如 Sentry）
- 监控 API 使用量
- 监控 Redis 队列状态

---

## 📚 相关资源

- [Supabase 文档](https://supabase.com/docs)
- [BullMQ 文档](https://docs.bullmq.io/)
- [Gemini API 文档](https://ai.google.dev/docs)
- [Next.js 环境变量](https://nextjs.org/docs/basic-features/environment-variables)

---

**配置完成后，你就可以开始使用畅理题库平台了！** 🎉
