# 产品需求文档 (PRD) - 管理面板（开发者题库管理界面）

## 文档信息
- **版本**: v1.0.0
- **创建日期**: 2026-02-05
- **产品定位**: 题库刷题平台 - 开发者管理端
- **目标用户**: 平台管理员、题库内容创作者

---

## 一、产品定位与愿景

### 1.1 核心使命
为平台管理员和内容创作者提供**高效的题库生产工具**，支持文件上传、AI自动解析、人工编辑修复、一键发布等全流程，快速将杂乱题库转化为高质量的刷题资源。

### 1.2 产品定位
**生产力工具**：帮助开发者快速处理题库，提高内容生产效率
- 核心目标：让开发者能够**同时处理多门科目**（50-100门）
- 优先级：**效率 > 功能完整性**
- 兜底策略：AI失败时，提供强大的人工编辑能力

### 1.3 核心价值主张
1. **批量处理能力**：一次上传多个题库文件，并行解析
2. **AI自动解析**：自动识别题目、答案、解析，减少人工工作
3. **人工兜底机制**：AI解析失败时，提供完整的编辑工具
4. **一键发布**：审核无误后，一键发布到客户端
5. **报错反馈**：接收用户报错，快速修复问题
6. **批量操作**：批量导入、批量编辑、批量发布

---

## 二、用户画像 (Persona)

### 2.1 目标用户
- **平台管理员**：负责题库内容的生产和维护，需要快速处理大量题库
- **内容创作者**：负责特定科目的题库整理，需要高效的编辑工具

### 2.2 核心痛点
1. **题库格式混乱**：TXT、MD格式不统一，解析困难
2. **人工整理耗时**：手动录入题目、答案、解析，工作量巨大
3. **AI解析不稳定**：AI解析失败率高，需要人工修复
4. **批量操作困难**：一次只能处理一个题库，效率低
5. **错误反馈滞后**：用户发现错误后，修复流程繁琐

### 2.3 关键使用场景
- **场景1：批量上传题库**：管理员准备50门科目的题库文件，一次性上传，系统自动解析
- **场景2：AI解析失败修复**：AI解析某个题库失败，管理员进入编辑模式，手动修复格式错误
- **场景3：人工核实答案**：AI解析完成后，管理员抽样检查题目和答案，确认无误后发布
- **场景4：处理用户报错**：收到用户报错"第5题答案有误"，管理员快速定位并修复
- **场景5：AI辅助核实**：管理员不确定某个答案是否正确，使用AI辅助核实功能

---

## 三、产品路线图 (Product Roadmap)

### V1: 最小可行产品 (MVP)

#### 核心功能
1. **文件上传模块**
   - 支持单文件上传（TXT、MD）
   - 显示文件信息（名称、大小、格式）
   - 上传进度显示
   - 文件预览（纯文本）

2. **AI自动解析**
   - 上传后自动触发AI解析
   - 实时显示解析进度（如：解析中 15/100）
   - 解析状态：pending → processing → completed/failed
   - 解析完成后生成预览HTML

3. **题库列表管理**
   - 显示所有题库（已发布+草稿）
   - 状态筛选（全部/草稿/已发布/失败）
   - 题库信息：名称、题目数量、状态、创建时间
   - 操作：编辑、发布、下架、删除

4. **题库编辑器**
   - **在线编辑模式**：直接编辑HTML内容
   - **预览模式**：实时预览刷题效果
   - **批量替换**：批量替换文本（如统一格式）
   - **题目级编辑**：定位到具体题目进行修改

5. **人工兜底机制**
   - AI解析失败时，显示错误信息
   - 提供"手动修复"入口
   - 支持纯文本模式编辑（适合复杂修复）
   - 保存修复后，重新生成HTML

6. **AI辅助功能**
   - **AI辅助核实**：选中某个题目，AI核实答案是否正确
   - **AI补全解析**：解析为空时，AI自动生成解析
   - **AI格式优化**：AI自动优化题库格式（统一选项、答案格式）

7. **发布管理**
   - 一键发布题库
   - 发布前预览（客户端视角）
   - 发布后显示在客户端题库广场
   - 支持下架已发布的题库

8. **报错反馈**
   - 查看用户报错列表
   - 显示报错详情（题目、错误原因、用户ID）
   - 快速定位到问题题目
   - 修复后标记为"已处理"

9. **数据统计**
   - 题库统计：总数、已发布、草稿、失败
   - 解析成功率
   - 用户报错数量
   - 热门题库（刷题次数Top10）

### V2 及以后版本 (Future Releases)

#### V2 功能
- **批量上传**：一次选择多个文件，批量上传和解析
- **OCR集成**：支持上传图片/PDF，自动OCR识别
- **题库模板**：提供标准题库模板，降低格式要求
- **版本控制**：题库编辑历史，支持回滚
- **协作编辑**：多人协作编辑同一题库
- **AI自动审核**：AI自动检查题库质量（答案正确性、格式规范性）
- **题库标签**：自定义标签，方便分类和管理

#### V3 功能
- **题库导入导出**：支持从第三方平台导入题库
- **智能推荐**：AI推荐相似题目，避免重复
- **题库合并**：将多个题库合并为一个
- **题库拆分**：将一个题库按章节/难度拆分

---

## 四、关键业务逻辑 (Business Rules)

### 4.1 题库生命周期规则
```
上传文件 → 创建草稿 → AI解析 → 解析完成 → 人工审核 → 发布 → 已发布
                                      ↓
                                  解析失败 → 人工修复 → 重新解析 → 发布
```

### 4.2 解析队列规则
1. **上传即入队**：文件上传后，立即创建解析任务
2. **并行解析**：支持多个题库同时解析（限制5个并发）
3. **失败重试**：解析失败后，自动重试1次
4. **超时处理**：解析超过5分钟，标记为失败

### 4.3 编辑权限规则
1. **草稿状态**：可自由编辑
2. **已发布状态**：编辑后需要重新发布（或直接热更新）
3. **有用户数据的题库**：编辑时提示"已有X用户刷过此题库"

### 4.4 发布规则
1. **发布前检查**：
   - 题目数量 > 0
   - 每题都有答案
   - HTML格式正确
2. **发布后不可删除**：只能下架（保留已有用户数据）
3. **下架后客户端不可见**：但已刷题的用户仍可查看历史记录

### 4.5 报错处理规则
1. **报错分类**：
   - 答案错误
   - 解析不清
   - 题目缺失
   - 格式问题
2. **优先级**：答案错误 > 解析不清 > 其他
3. **处理流程**：查看报错 → 定位题目 → 修复 → 标记已处理

---

## 五、数据契约 (Data Contract)

### 5.1 核心实体（与客户端共享）

#### quizzes（题库表）
```sql
quizzes (
  id UUID PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  subject VARCHAR(100),
  exam_type VARCHAR(100),
  difficulty VARCHAR(20),
  question_count INT DEFAULT 0,
  is_published BOOLEAN DEFAULT false,
  html TEXT,
  file_path VARCHAR(255),              -- 原始文件路径
  file_type VARCHAR(20),               -- 文件类型（txt/md）
  status VARCHAR(20) DEFAULT 'pending', -- pending/processing/completed/failed
  error_msg TEXT,                      -- 解析错误信息
  parse_progress INT DEFAULT 0,        -- 解析进度（0-100）
  order_mode INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
)
```

#### parse_jobs（解析任务表）
```sql
parse_jobs (
  id UUID PRIMARY KEY,
  quiz_id UUID REFERENCES quizzes(id),
  status VARCHAR(20) DEFAULT 'pending', -- pending/processing/completed/failed
  progress INT DEFAULT 0,               -- 解析进度（题目数/总数）
  error TEXT,
  started_at TIMESTAMP,
  completed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
)
```

#### error_reports（用户报错表）
```sql
error_reports (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  quiz_id UUID REFERENCES quizzes(id),
  question_index INT NOT NULL,
  error_type VARCHAR(50),              -- 答案错误/解析不清/题目缺失/格式问题
  description TEXT,
  status VARCHAR(20) DEFAULT 'pending', -- pending/resolved/ignored
  admin_note TEXT,                     -- 管理员备注
  created_at TIMESTAMP DEFAULT NOW(),
  resolved_at TIMESTAMP
)
```

#### admin_audit_log（管理员操作日志表）
```sql
admin_audit_log (
  id UUID PRIMARY KEY,
  admin_id UUID REFERENCES users(id),
  action VARCHAR(50),                  -- create_quiz/edit_quiz/publish_quiz/unpublish_quiz/fix_error
  target_type VARCHAR(50),             -- quiz/error_report
  target_id UUID,
  details JSONB,
  created_at TIMESTAMP DEFAULT NOW()
)
```

### 5.2 数据读写频率与一致性要求

#### 高频写入
- **解析进度**：每解析完一题更新一次
- **题库编辑**：每次保存时写入

#### 低频读取
- **报错列表**：管理员定期查看
- **统计数据**：每小时更新一次

#### 数据一致性
- **强一致性**：题库发布状态必须实时更新
- **最终一致性**：解析进度允许短暂延迟

---

## 六、UI/UX 设计要求

### 6.1 设计原则
1. **效率优先**：减少操作步骤，支持批量操作
2. **信息密度高**：表格布局，一屏显示更多信息
3. **即时反馈**：解析进度、操作结果实时显示
4. **错误友好**：清晰的错误提示，提供解决方案

### 6.2 管理面板首页布局

```
┌─────────────────────────────────────────────────────────────────┐
│  Changli OJ - 管理面板                          [管理员] [退出] │
├─────────────────────────────────────────────────────────────────┤
│  统计概览                                                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │总题库数  │  │ 已发布   │  │ 草稿     │  │ 失败     │        │
│  │   50    │  │   35     │  │   12     │  │   3      │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                      │
│  │解析成功率│  │待处理报错│  │热门题库   │                      │
│  │   94%   │  │   8      │  │ 驾考科目一 │                      │
│  └──────────┘  └──────────┘  └──────────┘                      │
├─────────────────────────────────────────────────────────────────┤
│  [上传新题库]  [刷新]                                            │
├─────────────────────────────────────────────────────────────────┤
│  题库列表                                                        │
│  筛选: [全部] [已发布] [草稿] [失败]  搜索: [按名称搜索...]    │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 题库名称     │ 状态      │ 题目数 │ 更新时间   │ 操作      │ │
│  ├───────────────────────────────────────────────────────────┤ │
│  │ 驾考科目一   │ 已发布   │ 1500  │ 2小时前   │ [编辑][下架]│ │
│  │ 高数上册     │ 已发布   │ 500   │ 1天前    │ [编辑][下架]│ │
│  │ 英语四级     │ 草稿     │ 2000  │ 3小时前   │ [编辑][发布]│ │
│  │ 数据结构     │ 解析中   │ -     │ 10分钟前  │ [查看进度] │ │
│  │ 操作系统     │ 失败     │ -     │ 1天前     │ [修复]     │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 6.3 上传文件界面

```
┌─────────────────────────────────────────────────────────────────┐
│  上传新题库                                    [取消] [保存]    │
├─────────────────────────────────────────────────────────────────┤
│  步骤1: 上传文件                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  拖拽文件到这里，或点击选择文件                          │   │
│  │  支持格式: .txt, .md，文件大小 ≤ 10MB                   │   │
│  │  [选择文件]                                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  步骤2: 题库信息                                                 │
│  题库名称: [驾考科目一                        ]               │
│  科目: [驾考 ▼]       考试类型: [驾考 ▼]                       │
│  难度: [简单 ▼]       描述: [机动车驾驶理论考试...      ]     │
│                                                                  │
│  步骤3: 预览                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 1. 驾驶机动车在高速公路上行驶...                         │   │
│  │ A. 50米以上                                            │   │
│  │ B. 100米以上                                           │   │
│  │ ...                                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  [开始解析]                                                       │
└─────────────────────────────────────────────────────────────────┘
```

### 6.4 题库编辑器界面

```
┌─────────────────────────────────────────────────────────────────┐
│  编辑题库: 驾考科目一                       [保存] [取消] [发布]│
├─────────────────────────────────────────────────────────────────┤
│  [编辑模式▼] [预览模式] [纯文本模式]                             │
│                                                                  │
│  ┌─────────────────────────────┬───────────────────────────────┐│
│  │ 编辑区（40%）                │ 预览区（60%）                 ││
│  │ ┌───────────────────────┐   │ ┌───────────────────────────┐ ││
│  │ <div class="question">   │   │ 1. 驾驶机动车在高速公路上  │ ││
│  │   <p>1. 驾驶机动车...  │   │    行驶，车速超过100km/h  │ ││
│  │   </p>                  │   │    时，应与同车道前车保  │ ││
│  │   <div class="options">  │   │    持多少米以上的距离？  │ ││
│  │     <div>A. 50米以上</div│   │                            │ ││
│  │     <div>B. 100米以上</ │   │    A. 50米以上            │ ││
│  │     <div>C. 150米以上</ │   │    B. 100米以上           │ ││
│  │     <div>D. 200米以上</ │   │    C. 150米以上           │ ││
│  │     <div>正确答案: B</  │   │    D. 200米以上           │ ││
│  │     <div>解析: 根据...  │   │                            │ ││
│  │   </div>                │   │    [点击查看答案]          │ ││
│  │ </div>                  │   │                            │ ││
│  │                         │   │    ✅ 正确答案: B         │ ││
│  │ [题目列表▼]             │   │    📝 解析: 根据...       │ ││
│  │ 1. 驾驶机动车...         │   │                            │ ││
│  │ 2. 设函数f(x)...         │   │                            │ ││
│  │ 3. ...                   │   │                            │ ││
│  └─────────────────────────┘   └───────────────────────────┘ ││
├───────────────────────────────┴───────────────────────────────┤
│  [批量替换] [AI辅助核实] [AI补全解析] [AI格式优化]             │
└─────────────────────────────────────────────────────────────────┘
```

### 6.5 AI解析进度界面

```
┌─────────────────────────────────────────────────────────────────┐
│  解析进度: 驾考科目一                          [后台运行] [取消]│
├─────────────────────────────────────────────────────────────────┤
│  当前状态: 解析中  ████████████████░░░░  150/1500 (10%)        │
│                                                                  │
│  最近日志:                                                       │
│  [10:30:15] 开始解析文件: quiz.txt (2.5MB)                     │
│  [10:30:16] 正在解析第 1 题...                                  │
│  [10:30:17] ✅ 第 1 题解析成功                                 │
│  [10:30:17] 正在解析第 2 题...                                  │
│  ...                                                             │
│  [10:32:45] ✅ 第 150 题解析成功                                │
│  [10:32:46] 正在解析第 151 题...                                │
│                                                                  │
│  预计剩余时间: 12 分钟                                           │
└─────────────────────────────────────────────────────────────────┘
```

### 6.6 报错反馈列表界面

```
┌─────────────────────────────────────────────────────────────────┐
│  用户报错                                                    [刷新]│
├─────────────────────────────────────────────────────────────────┤
│  筛选: [全部] [待处理] [已处理]  类型: [全部▼]                  │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 题库     │ 题目 │ 类型     │ 报错内容    │ 时间   │ 操作│ │
│  ├───────────────────────────────────────────────────────────┤ │
│  │ 驾考一   │ #5  │ 答案错误 │ 答案应该是C │ 2小时前│[修复]│ │
│  │ 高数上册 │ #12 │ 解析不清 │ 解析太简略 │ 1天前 │[修复]│ │
│  │ 英语四级 │ #88 │ 题目缺失 │ 题目不完整 │ 3天前 │[修复]│ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

---

## 七、技术架构建议

### 7.1 前端技术栈
- **框架**: Next.js 14+ (App Router)
- **样式**: Tailwind CSS
- **UI组件**: shadcn/ui
- **代码编辑器**: CodeMirror / Monaco Editor
- **富文本编辑器**: TipTap / Lexical

### 7.2 后端技术栈
- **API**: Next.js API Routes
- **数据库**: Supabase (PostgreSQL)
- **队列**: BullMQ + Redis（解析任务队列）
- **Worker**: 独立Worker服务（部署在Render/Railway）
- **文件存储**: Supabase Storage / 本地文件系统（MVP）

### 7.3 AI集成
- **主API**: Gemini API
- **备用API**: OpenAI API
- **Prompt模板**: 预定义解析Prompt，提高准确率

### 7.4 核心依赖
```json
{
  "dependencies": {
    "next": "^14.0.0",
    "react": "^18.0.0",
    "supabase-js": "^2.0.0",
    "@ai-sdk/google": "^0.0.0",
    "bullmq": "^5.0.0",
    "ioredis": "^5.0.0",
    "@monaco-editor/react": "^4.0.0",
    "tailwindcss": "^3.0.0"
  }
}
```

---

## 八、成功指标 (KPI)

### 8.1 核心指标
- **题库生产效率**: 每个工作日完成题库数量 ≥ 10个
- **解析成功率**: AI解析成功率 ≥ 85%
- **报错响应时间**: 从收到报错到修复完成 < 24小时
- **题库质量**: 用户报错率 < 1%

### 8.2 体验指标
- **解析速度**: 1000题题库解析时间 < 10分钟
- **编辑体验**: 编辑器加载时间 < 2秒，保存延迟 < 500ms
- **错误率**: 系统错误率 < 0.5%

---

## 九、风险与假设

### 9.1 关键假设
1. **文件格式相对规范**：假设用户上传的TXT/MD文件有基本的题目结构
2. **AI解析准确率可接受**：假设AI解析准确率 ≥ 85%
3. **管理员技术能力**：假设管理员能够使用HTML编辑器修复错误

### 9.2 主要风险
1. **AI解析失败率过高**：如果失败率 > 30%，管理员工作量过大
2. **文件格式多样性**：用户上传的文件格式千差万别，难以统一解析
3. **并发解析限制**：BullMQ Worker部署复杂，可能成为瓶颈
4. **成本控制**：AI解析成本可能超预算

### 9.3 缓解措施
1. **AI解析失败**：提供强大的人工编辑工具，支持快速修复
2. **文件格式多样性**：提供标准模板，引导用户按模板整理
3. **并发解析限制**：MVP阶段限制并发数为3，后续根据实际情况调整
4. **成本控制**：设置每日解析题数上限，监控AI API成本

---

## 十、与客户端的区别

| 维度 | 客户端 | 管理面板 |
|------|--------|----------|
| **目标用户** | 备考学员 | 平台管理员 |
| **核心目标** | 刷题体验 | 内容生产效率 |
| **功能优先级** | 浏览 > 刷题 > AI追问 | 解析 > 编辑 > 发布 |
| **UI风格** | 简洁、大屏友好 | 信息密度高、效率优先 |
| **技术复杂度** | 中等（无队列） | 高（BullMQ + Worker） |
| **AI使用** | 追问（低频） | 解析（高频） |

---

## 十一、附录

### 11.1 题库文件格式示例

#### TXT格式示例
```
1. 驾驶机动车在高速公路上行驶，车速超过100km/h时，应与同车道前车保持多少米以上的距离？
A. 50米以上
B. 100米以上
C. 150米以上
D. 200米以上
答案：B
解析：根据《道路交通安全法》第67条规定...

2. 设函数f(x)=x²-2x+3，求f'(1)的值。
答案：0
解析：f'(x)=2x-2，所以f'(1)=2*1-2=0
```

#### Markdown格式示例
```markdown
## 驾驶机动车在高速公路上行驶，车速超过100km/h时，应与同车道前车保持多少米以上的距离？
A. 50米以上
B. 100米以上
C. 150米以上
D. 200米以上

**答案**：B

**解析**：根据《道路交通安全法》第67条规定...

---

## 设函数f(x)=x²-2x+3，求f'(1)的值。

**答案**：0

**解析**：f'(x)=2x-2，所以f'(1)=2*1-2=0
```

### 11.2 AI解析Prompt模板

```markdown
你是一个专业的题库解析助手。请将以下文本解析成结构化的题库HTML格式。

要求：
1. 识别题目类型（选择题/填空题/大题）
2. 提取题干、选项、正确答案、解析
3. 生成符合规范的HTML格式
4. 如果无法识别，返回错误信息

输入文本：
{{RAW_TEXT}}

请按以下JSON格式输出：
{
  "success": true/false,
  "questions": [
    {
      "type": "choice/fill/essay",
      "questionText": "...",
      "options": ["A. ...", "B. ..."],
      "correctAnswer": "...",
      "explanation": "..."
    }
  ],
  "error": "错误信息（如果失败）"
}
```

---

**文档结束**
